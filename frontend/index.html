<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>swch</title>
    <link rel="stylesheet" href="src/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><i class="fa-solid fa-repeat"></i> SWCH</div>
            
            <div class="nav-item active" onclick="switchTab('library')">
                <i class="fa-solid fa-gamepad"></i> Library
            </div>
            <div class="nav-item" onclick="switchTab('accounts')">
                <i class="fa-solid fa-users"></i> Accounts
            </div>
            
            <div class="nav-spacer"></div>
            <div class="nav-item action-btn" onclick="openAddGameModal()">
                <i class="fa-solid fa-plus"></i> Add Game
            </div>
        </aside>

        <main class="main-content">
            <div id="view-library" class="view-section">
                <div class="header"><div class="title">Library</div></div>
                <div class="grid" id="games-grid"></div>
            </div>

            <div id="view-accounts" class="view-section" style="display: none;">
                <div class="header"><div class="title">Accounts</div></div>
                <div id="launchers-list"></div>
                </div>
        </main>
    </div>

    <div id="account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-game-title">Launch</h3>
                <span class="close" onclick="closeModal('account-modal')">&times;</span>
            </div>
            <div id="modal-accounts-list" class="modal-list"></div>
        </div>
    </div>

    <div id="note-select-modal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-header">
                <h3>Account Tag</h3>
                <span class="close" onclick="closeModal('note-select-modal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="sticker-btn btn-main" onclick="savePredefinedNote('Main')">
                        <i class="fa-solid fa-crown"></i> MAIN
                    </button>
                    <button class="sticker-btn btn-smurf" onclick="savePredefinedNote('Smurf')">
                        <i class="fa-solid fa-child"></i> SMURF
                    </button>
                    <button class="sticker-btn btn-vac" onclick="savePredefinedNote('VAC')">
                        <i class="fa-solid fa-ban"></i> VAC
                    </button>
                </div>
                
                <div style="border-top: 1px solid #444; padding-top: 15px;">
                    <input type="text" id="custom-note-input" placeholder="Or type custom note..." class="input-field" style="width:100%; box-sizing:border-box; padding:10px; background:#222; border:1px solid #444; color:white; margin-bottom:10px;">
                    <button onclick="saveCustomNote()" style="width:100%; padding:8px; background:#0074e4; border:none; color:white; cursor:pointer;">Save Text</button>
                </div>

                <button class="sticker-btn btn-clear" onclick="savePredefinedNote('')">
                    <i class="fa-solid fa-eraser"></i> Clear Tag
                </button>
            </div>
        </div>
    </div>

    <div id="edit-account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Account Details</h3>
                <span class="close" onclick="closeModal('edit-account-modal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <label style="color:#aaa; font-size:12px;">Comment (visible in Accounts tab):</label>
                <input type="text" id="edit-comment" placeholder="e.g. My main account" class="input-field" style="width:100%; margin-bottom:15px; padding:10px; background:#333; border:none; color:white;">
                
                <label style="color:#aaa; font-size:12px;">Custom Avatar:</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="edit-avatar-path" placeholder="Path to image..." class="input-field" style="flex:1; padding:10px; background:#333; border:none; color:white;" readonly>
                    <button onclick="selectNewAvatar()" style="padding:10px 15px; background:#0074e4; border:none; color:white; cursor:pointer;">Browse</button>
                </div>
                
                <button onclick="saveAccountChanges()" style="width:100%; margin-top:20px; padding:10px; background:#2d8c58; border:none; color:white; cursor:pointer; font-weight:bold;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="add-game-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Non-Steam Game</h3>
                <span class="close" onclick="closeModal('add-game-modal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="text" id="custom-name" placeholder="Game Name" class="input-field" style="width:100%; margin-bottom:10px; padding:10px; background:#333; border:none; color:white;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="custom-path" placeholder="Path to .exe" class="input-field" style="flex:1; padding:10px; background:#333; border:none; color:white;" readonly>
                    <button onclick="browseFile()" style="padding:10px 15px; background:#0074e4; border:none; color:white; cursor:pointer;">Browse</button>
                </div>
                <button onclick="saveCustomGame()" style="width:100%; margin-top:20px; padding:10px; background:#2d8c58; border:none; color:white; cursor:pointer; font-weight:bold;">Add to Library</button>
            </div>
        </div>
    </div>

    <div id="save-epic-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Save Current Epic Account</h3>
                <span class="close" onclick="closeModal('save-epic-modal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="color:#aaa; font-size:13px; margin-bottom:15px;">
                    Make sure you are currently logged into the Epic Games Launcher with the account you want to save.
                </p>
                <input type="text" id="epic-save-name" placeholder="Account Name (e.g. Main)" class="input-field" style="width:100%; margin-bottom:10px; padding:10px; background:#333; border:none; color:white;">
                <button onclick="doSaveEpic()" style="width:100%; margin-top:10px; padding:10px; background:#0074e4; border:none; color:white; cursor:pointer; font-weight:bold;">Save Profile</button>
            </div>
        </div>
    </div>

    <script src="/wailsjs/go/app/App.js"></script>
    
    <script>
        // ... (предыдущий JS код без изменений, добавляем только новые функции) ... 
        
        // --- UPDATED JS ---
        let globalGames = [];
        let editingTagTarget = { username: '', platform: '', gameId: '' };
        let editingAccountTarget = { username: '', platform: '' };

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(tab === 'library') {
                document.getElementById('view-library').style.display = 'block';
                loadLibrary();
            } else {
                document.getElementById('view-accounts').style.display = 'block';
                loadAccounts();
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function loadLibrary() {
            const list = document.getElementById('games-grid');
            list.innerHTML = 'Loading...';
            const games = await window['go']['app']['App']['GetLibrary']();
            globalGames = games;
            list.innerHTML = '';

            if(!games.length) list.innerHTML = "No games found.";

            games.forEach(game => {
                const card = document.createElement('div');
                card.className = 'card';
                
                let overlay = '';
                // Проверяем isInstalled. Если false - добавляем класс и иконку
                if (!game.isInstalled) {
                    card.classList.add('game-not-installed');
                    overlay = '<div class="install-overlay"><i class="fa-solid fa-download"></i></div>';
                }

                card.onclick = () => openGameModal(game.id);
                
                let platColor = '#0074e4';
                if(game.platform === 'Steam') platColor = '#1b2838';
                if(game.platform === 'Epic') platColor = '#333';
                if(game.platform === 'Custom') platColor = '#2d8c58';

                const img = game.iconUrl || 'https://via.placeholder.com/300x169?text=' + encodeURIComponent(game.name);

                card.innerHTML = `
                    <div class="platform-badge" style="background:${platColor}">${game.platform}</div>
                    ${overlay}
                    <img src="${img}" class="card-img" style="height:150px; width:100%; object-fit:cover;">
                    <div class="card-info">
                        <div class="game-title" style="font-weight:bold;">${game.name}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function openGameModal(gameId) {
            const game = globalGames.find(g => g.id === gameId);
            if(!game) return;

            if (game.platform === 'Custom') {
                launch('', game.id, game.platform, game.exePath);
                return;
            }

            const actionVerb = game.isInstalled ? "Launch" : "Install";
            const actionIcon = game.isInstalled ? "fa-play" : "fa-download";
            
            document.getElementById('modal-game-title').innerText = `${actionVerb} ${game.name}`;
            const list = document.getElementById('modal-accounts-list');
            list.innerHTML = '';

            if (!game.availableOn || game.availableOn.length === 0) {
                list.innerHTML = `<div class="modal-item" onclick="launch('', '${game.id}', '${game.platform}', '')">
                    <div class="acc-name">${actionVerb} Game</div><div class="acc-meta">Current Account</div>
                </div>`;
            } else {
                game.availableOn.forEach(acc => {
                    const item = document.createElement('div');
                    item.className = 'modal-item';
                    
                    let noteHtml = '';
                    if (acc.note === 'Main') noteHtml = `<span class="badge badge-main"><i class="fa-solid fa-crown"></i> MAIN</span>`;
                    else if (acc.note === 'Smurf') noteHtml = `<span class="badge badge-smurf"><i class="fa-solid fa-child"></i> SMURF</span>`;
                    else if (acc.note === 'VAC') noteHtml = `<span class="badge badge-vac"><i class="fa-solid fa-ban"></i> VAC BAN</span>`;
                    else if (acc.note) noteHtml = `<span class="badge badge-custom"><i class="fa-solid fa-note-sticky"></i> ${acc.note}</span>`;

                    item.innerHTML = `
                        <div style="flex:1" onclick="launch('${acc.username}', '${game.id}', '${game.platform}', '')">
                            <div class="acc-name" style="font-weight:bold; display:flex; align-items:center;">
                                <i class="fa-solid ${actionIcon}" style="margin-right:8px; font-size:12px; color:#aaa;"></i>
                                ${acc.displayName}
                                ${noteHtml}
                            </div>
                            <div class="acc-meta" style="font-size:12px; color:#aaa;">Login: ${acc.username}</div>
                        </div>
                        <div class="edit-note-btn" onclick="openNoteSelector('${acc.username}', '${game.platform}', '${game.id}', '${acc.note || ''}')" title="Tag Account">
                            <i class="fa-solid fa-tag"></i>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            document.getElementById('account-modal').style.display = 'flex';
        }

        async function launch(account, gameId, platform, exePath) {
            closeModal('account-modal');
            const res = await window['go']['app']['App']['LaunchGame'](account, gameId, platform, exePath);
            if(res && !res.startsWith("Launched") && !res.startsWith("Success")) {
                 alert(res);
            }
        }
        
        // ... (функции NoteSelector и EditAccount без изменений) ...

        async function loadAccounts() {
            const container = document.getElementById('launchers-list');
            container.innerHTML = '<div style="padding:20px">Loading accounts...</div>';
            
            const launchers = await window['go']['app']['App']['GetLaunchers']();
            container.innerHTML = '';

            launchers.forEach(group => {
                const section = document.createElement('div');
                section.className = 'launcher-section';
                
                let accountsHtml = '';
                group.accounts.forEach(acc => {
                    let avatarHtml = `<div class="acc-avatar">${acc.displayName.charAt(0)}</div>`;
                    if(acc.avatarUrl) {
                        avatarHtml = `<div class="acc-avatar" style="background-image: url('${acc.avatarUrl.replace(/\\/g, '/')}'); background-size: cover; color: transparent;"></div>`;
                    }
                    const commentHtml = acc.comment ? `<div class="acc-comment">${acc.comment}</div>` : '';

                    accountsHtml += `
                        <div class="account-row interactable" onclick="switchAccount('${acc.username}', '${group.platform}')">
                            ${avatarHtml}
                            <div class="acc-details">
                                <div class="acc-nick">
                                    ${acc.displayName}
                                    ${commentHtml}
                                </div>
                                <div class="acc-login">${acc.username}</div>
                            </div>
                            
                            <div class="acc-actions" onclick="event.stopPropagation()">
                                <div class="action-icon-btn" title="Edit details" onclick="openEditAccount('${acc.username}', '${group.platform}', '${acc.comment || ''}')">
                                    <i class="fa-solid fa-pen"></i>
                                </div>
                                <div class="action-icon-btn delete-btn" title="Hide form list" onclick="deleteAccount('${acc.username}', '${group.platform}')">
                                    <i class="fa-solid fa-trash"></i>
                                </div>
                            </div>

                            <div class="acc-action-icon">
                                <i class="fa-solid fa-arrow-right-to-bracket"></i>
                            </div>
                        </div>
                    `;
                });
                
                // Добавляем кнопку добавления аккаунта для Epic
                let footerHtml = '';
                if(group.platform === 'Epic') {
                    footerHtml = `
                        <div style="padding:10px; text-align:center; border-top:1px solid #2a2a2a;">
                            <button onclick="openSaveEpicModal()" style="background:transparent; border:1px dashed #444; color:#888; width:100%; padding:8px; cursor:pointer;">
                                <i class="fa-solid fa-plus"></i> Save Current Epic Account
                            </button>
                        </div>
                    `;
                }

                section.innerHTML = `
                    <div class="launcher-header">
                        <i class="fa-brands fa-${group.platform.toLowerCase()}"></i> ${group.name} 
                        <span class="count">${group.accounts.length}</span>
                    </div>
                    <div class="launcher-accounts">
                        ${accountsHtml}
                    </div>
                    ${footerHtml}
                `;
                container.appendChild(section);
            });
        }

        async function switchAccount(username, platform) {
            const res = await window['go']['app']['App']['SwitchToAccount'](username, platform);
            alert(res);
        }

        // --- EPIC SAVE LOGIC ---
        function openSaveEpicModal() {
            document.getElementById('epic-save-name').value = '';
            document.getElementById('save-epic-modal').style.display = 'flex';
        }

        async function doSaveEpic() {
            const name = document.getElementById('epic-save-name').value;
            if(!name) return;
            const res = await window['go']['app']['App']['SaveEpicAccount'](name);
            alert(res);
            closeModal('save-epic-modal');
            loadAccounts();
        }

        // ... (остальные функции без изменений) ...
        
        // Вставка функций из старого кода, чтобы не потерялись
        function openNoteSelector(username, platform, gameId, currentNote) {
            editingTagTarget = { username, platform, gameId };
            const isPredefined = ['Main','Smurf','VAC'].includes(currentNote);
            document.getElementById('custom-note-input').value = isPredefined ? '' : currentNote;
            document.getElementById('note-select-modal').style.display = 'flex';
        }
        async function savePredefinedNote(noteType) { await applyNote(noteType); }
        async function saveCustomNote() { const text = document.getElementById('custom-note-input').value; await applyNote(text); }
        async function applyNote(noteText) {
            const { username, platform, gameId } = editingTagTarget;
            await window['go']['app']['App']['UpdateGameNote'](username, platform, gameId, noteText);
            const game = globalGames.find(g => g.id === gameId);
            if(game) {
                const acc = game.availableOn.find(a => a.username === username);
                if(acc) acc.note = noteText;
            }
            closeModal('note-select-modal');
            openGameModal(gameId);
        }
        async function deleteAccount(username, platform) {
            if(confirm(`Hide account ${username} from the list?`)) {
                await window['go']['app']['App']['DeleteAccount'](username, platform);
                loadAccounts();
            }
        }
        function openEditAccount(username, platform, currentComment) {
            editingAccountTarget = { username, platform };
            document.getElementById('edit-comment').value = currentComment;
            document.getElementById('edit-avatar-path').value = '';
            document.getElementById('edit-account-modal').style.display = 'flex';
        }
        async function selectNewAvatar() {
            const path = await window['go']['app']['App']['SelectImage']();
            if(path) document.getElementById('edit-avatar-path').value = path;
        }
        async function saveAccountChanges() {
            const comment = document.getElementById('edit-comment').value;
            const avatar = document.getElementById('edit-avatar-path').value;
            await window['go']['app']['App']['UpdateAccountData'](editingAccountTarget.username, editingAccountTarget.platform, comment, avatar);
            closeModal('edit-account-modal');
            loadAccounts();
        }
        function openAddGameModal() { document.getElementById('add-game-modal').style.display = 'flex'; }
        async function browseFile() {
            const path = await window['go']['app']['App']['SelectExe']();
            if(path) document.getElementById('custom-path').value = path;
        }
        async function saveCustomGame() {
            const name = document.getElementById('custom-name').value;
            const path = document.getElementById('custom-path').value;
            const res = await window['go']['app']['App']['AddCustomGame'](name, path);
            if(res === 'Success') {
                closeModal('add-game-modal');
                loadLibrary();
                document.getElementById('custom-name').value = ''; 
                document.getElementById('custom-path').value = '';
            } else { alert(res); }
        }

        loadLibrary();
    </script>
</body>
</html>