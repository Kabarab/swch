<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>swch</title>
    <link rel="stylesheet" href="src/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo"><i class="fa-solid fa-repeat"></i> SWCH</div>
            
            <div class="nav-item active" onclick="switchTab('library')">
                <i class="fa-solid fa-gamepad"></i> Games Library
            </div>
            <div class="nav-item" onclick="switchTab('accounts')">
                <i class="fa-solid fa-users"></i> Accounts
            </div>
            
            <div class="nav-spacer"></div>
            <div class="nav-item"><i class="fa-solid fa-gear"></i> Settings</div>
        </aside>

        <main class="main-content">
            
            <div id="view-library" class="view-section">
                <div class="header">
                    <div class="title">Installed Games</div>
                    <div class="subtitle">All launchers combined</div>
                </div>
                <div class="grid" id="games-grid"></div>
            </div>

            <div id="view-accounts" class="view-section" style="display: none;">
                <div class="header">
                    <div class="title">Accounts Manager</div>
                </div>
                <div id="launchers-list"></div>
            </div>

        </main>
    </div>

    <div id="account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-game-title">Select Account</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-accounts-list" class="modal-list">
                </div>
        </div>
    </div>

    <script src="/wailsjs/go/app/App.js"></script>
    
    <script>
        let globalGames = [];

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            if (tabName === 'library') {
                document.getElementById('view-library').style.display = 'block';
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                loadLibrary();
            } else {
                document.getElementById('view-accounts').style.display = 'block';
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                loadAccounts();
            }
        }

        // --- LIBRARY LOGIC ---
        async function loadLibrary() {
            const list = document.getElementById('games-grid');
            list.innerHTML = '<div class="loading">Scanning games...</div>';
            
            const games = await window['go']['app']['App']['GetLibrary']();
            globalGames = games;
            list.innerHTML = '';

            if (!games || games.length === 0) {
                list.innerHTML = '<div class="empty">No games found.</div>';
                return;
            }

            games.forEach(game => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openGameModal(game.id);
                
                // Platform Badge color
                let platColor = '#0074e4';
                if(game.platform === 'Steam') platColor = '#1b2838';
                if(game.platform === 'Epic') platColor = '#333';

                card.innerHTML = `
                    <div class="platform-badge" style="background:${platColor}">${game.platform}</div>
                    <img src="${game.iconUrl}" class="card-img" onerror="this.src='https://via.placeholder.com/300x169?text=Game'">
                    <div class="card-info">
                        <div class="game-title">${game.name}</div>
                        <div class="account-count">Available on ${game.availableOn ? game.availableOn.length : 0} accounts</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function openGameModal(gameId) {
            const game = globalGames.find(g => g.id === gameId);
            if(!game) return;

            document.getElementById('modal-game-title').innerText = "Launch " + game.name;
            const list = document.getElementById('modal-accounts-list');
            list.innerHTML = '';

            if (!game.availableOn || game.availableOn.length === 0) {
                list.innerHTML = `<div class="modal-item" onclick="launch('', '${game.id}', '${game.platform}')">
                    <div class="acc-name">Launch without switching</div>
                    <div class="acc-meta">Just runs the exe/url</div>
                </div>`;
            } else {
                game.availableOn.forEach(acc => {
                    const item = document.createElement('div');
                    item.className = 'modal-item';
                    item.onclick = () => launch(acc.displayName, game.id, game.platform); // Note: using displayName as username for MVP
                    item.innerHTML = `
                        <div class="acc-name">${acc.displayName}</div>
                        <div class="acc-meta">Playtime: ${acc.playtimeMin} min</div>
                    `;
                    list.appendChild(item);
                });
            }

            document.getElementById('account-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('account-modal').style.display = 'none';
        }

        // --- ACCOUNTS LOGIC ---
        async function loadAccounts() {
            const container = document.getElementById('launchers-list');
            container.innerHTML = 'Loading...';
            
            const launchers = await window['go']['app']['App']['GetLaunchers']();
            container.innerHTML = '';

            launchers.forEach(group => {
                const section = document.createElement('div');
                section.className = 'launcher-section';
                
                let accountsHtml = '';
                group.accounts.forEach(acc => {
                    accountsHtml += `
                        <div class="account-row">
                            <div class="acc-avatar">${acc.displayName.charAt(0)}</div>
                            <div class="acc-details">
                                <div class="acc-nick">${acc.displayName}</div>
                                <div class="acc-login">${acc.username}</div>
                            </div>
                        </div>
                    `;
                });

                section.innerHTML = `
                    <div class="launcher-header">
                        <i class="fa-solid fa-layer-group"></i> ${group.name} 
                        <span class="count">${group.accounts.length}</span>
                    </div>
                    <div class="launcher-accounts">
                        ${accountsHtml}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        async function launch(account, gameId, platform) {
            closeModal();
            console.log("Launching", gameId, account, platform);
            await window['go']['app']['App']['LaunchGame'](account, gameId, platform);
        }

        // Init
        loadLibrary();
    </script>
</body>
</html>